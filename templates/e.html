<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://apis.google.com/js/platform.js?onload=onLoad" async defer></script>
    <meta name="google-signin-client_id"
        content="807588094774-v7tcl63kqsj96r64gaqhtu8gsn81ffnt.apps.googleusercontent.com">
    <link rel="stylesheet" href="{{url_for('static',filename='css/base.css')}}">
    <title>BooKÏ</title>
</head>

<body>
    <style>
        #wrap {
            display: flex;
            flex-direction: column;
            margin: 150px auto;
            width: 1200px;
            background: white;
        }

        #pageCover {
            display: flex;
            flex-direction: row;
            height: 400px;
            border: 0.5px solid #656565;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            ;
        }

        #theEventCover {
            background-repeat: no-repeat;
            background-size: cover;
            flex-grow: 2;
            border-top-left-radius: 8px;
        }

        #attendEvents {
            width: 300px;
            padding: 20px
        }

        #uppderDate {
            display: flex;
            flex-direction: column;
        }

        #theEventTitle {
            color: #656565;
            font-size: 28px;
            font-weight: 400;
            margin: 40px 0px;
        }

        #organiser {
            color: #8696a7;
            font-size: 20px;
        }

        #shareSec {
            display: flex;
            flex-direction: row;
            border: 0.5px solid #656565;
            border-top: none;
        }

        #share {
            flex-grow: 2
        }

        #attendBtn {
            width: 320px;
            height: 50px;
            margin: 10px 10px;
            background-color: #0D8547;
            color: white;
            font-size: 20px;
            border-radius: 8px;
            cursor: pointer;
            border: none;
        }

        #attendBtn:hover {
            background-color: #179C55
        }

        #eventBody {
            display: flex;
            flex-direction: row;
            border: 0.5px solid #656565;
            border-top: none;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;

        }

        .bodyTitle {
            font-size: 20px;
            font-weight: 500;
            margin-bottom: 20px;
        }

        #eventDes {
            padding: 20px;
            flex-grow: 2;
        }

        #bodyDes {
            margin-top: 10px;
        }

        #rightSec {
            display: flex;
            flex-direction: column;
            width: 300px;
            padding: 20px
        }

        #eventTime {
            display: flex;
            flex-direction: column;
        }

        #eventLoca,
        #manageAtt {
            margin-top: 20px;
        }

        .peopleN {
            margin-bottom: 10px
        }

        #bg {
            background-color: white;
            width: 100%;
            height: 100%;
            top: 0px;
            position: fixed;
            opacity: 0.3;
            -webkit-opacity: 0.3;
            display: none;
            z-index: 100;
        }

        #registerpopup {
            position: fixed;
            width: 400px;
            height: 300px;
            left: 50%;
            top: 80px;
            transform: translateX(-50%);
            box-shadow: 0px 4px 60px #AAAAAA;
            z-index: 999;
            background-color: #f9f8f4;
            border-radius: 20px;
            font-size: 28px;
        }

        #reBox {
            position: absolute;
            width: 350px;
            transform: translateY(-50%);
            top: 50%;
            left: 50%;
            text-align: center;
            transform: translateX(-50%);
        }

        .eventinput {
            height: 50px;
            margin: 20px 0px;
            width: 300px;
            border-radius: 8px;
            border: 1px solid gray;
            padding-left: 15px;
            font-size: 20px;
        }

        .cTitle {
            color: #030305;
        }

        .sBox {
            width: 350px;
            height: 280px;
            font-size: 28px;
            margin-top: 80px;
        }

        .gosigninBtnforE {
            position: absolute;
            width: 100px;
            height: 50px;
            right: 85px;
            margin-top: 20px;
            color: white;
            background-color: #c5b8a5;
            border: 1px solid #c5b8a5;
            border-radius: 8px;
            font-family: Helvetica;
            font-size: 20px;
            cursor: pointer;
        }

        .gosigninBtnforE:hover {
            color: black;
            background-color: white;
        }

        .cancelBtnforE {
            position: absolute;
            width: 100px;
            height: 48px;
            right: 200px;
            font-size: 20px;
            margin-top: 20px;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            background-color: white;
        }

        .cancelBtn:hover {
            border: 1px solid gray;
        }
    </style>
    <div class="searchEngine">
        <div class="Header">
            <a href="/">BooKÏ</a>
        </div>

        <div class="nav">
            <div class="menu"><a id="eventPage" href="/events">Events</a></div>
            <div class="menu signinIcon" id="signinIcon" style="display: none"><a id="signinProcess"
                    class="signinProcess" href="/accounts">Sign in</a></div>
            <div class="menu memIcon" id="memIcon" style="display: none">
                <i class="fas fa-user-astronaut"></i>
            </div>
        </div>

        <div id="memToggle" class="memToggle" style="display: none">
            <a href="/myevent">
                <div class="myEvent">My Collection</div>
            </a>
            <div id="signoutProcess" class="signoutProcess">Sign Out</div>
        </div>
    </div>

    <div id="wrap">

        <div id="pageCover">
            <div id="attendEvents">

            </div>
        </div>

        <div id="shareSec">
            <div id="share"></div>
            <button id="attendBtn">Register</button>
        </div>

        <div id="eventBody">
            <div id="eventDes">
                <div class="bodyTitle">About this event</div>

            </div>

            <div id="rightSec">
                <div id="eventTime">
                    <div class="bodyTitle">Date and Time</div>
                    <div id=downTime></div>
                </div>

                <div id="eventLoca">
                    <div class="bodyTitle">Location</div>
                    <div id="loca"></div>
                </div>

                <div id="manageAtt" style="display: none">
                    <div class="bodyTitle">Attendees</div>
                    <div id="attendee"></div>
                </div>
            </div>



        </div>
    </div>

    <label><a id="bgBtn" href="javascript:void(0)">
            <div id="bg"></div>
        </a></label>

    <div id="registerpopup" style="display: none;">
        <div id="reBox" style="display: none;">
            <div class="cTitle">Processing, please wait...</div>
        </div>

        <div id="sBox" class="sBox" style="display: none">
            <i class="fas fa-user-cog"></i><br>
            <div>Sign in with your BooKÏ Account to create an event</div>
            <button id="cancelBtn" class="cancelBtn">cancel</button><button id="gosigninBtn" class="gosigninBtn"
                onclick="goSignin()">Sign in</button>
        </div>

        <div id="goEventBox" class="sBox" style="display: none">
            <i class="far fa-calendar-check"></i>
            <div>Already registered!</div>
            <button id="cancelBtnforE" class="cancelBtnforE">cancel</button><button id="gomyeventBtn"
                class="gosigninBtnforE" onclick="goMycollection()">My Collection</button>
        </div>
    </div>




    <script src="https://kit.fontawesome.com/cbebce4b6d.js" crossorigin="anonymous"></script>
    <script src="{{url_for('static',filename='js/base.js')}}"></script>
    <script>

        let src = window.location.href;
        let eventId = src.split("/")[4];
        theEvent(eventId)

        let attendBtn = document.getElementById("attendBtn")
        let bg = document.getElementById("bg")
        let bgBtn = document.getElementById("bgBtn")
        let registerpopup = document.getElementById("registerpopup")
        let reBox = document.getElementById("reBox")
        let sBox = document.getElementById("sBox")
        let cancelBtn = document.getElementById("cancelBtn")
        let goEventBox = document.getElementById("goEventBox")

        bgBtn.addEventListener("click", function () {
            bg.style.display = "none"
            registerpopup.style.display = "none"
            sBox.style.display = "none"
            goEventBox.style.display = "none"
        })

        cancelBtn.addEventListener("click", function () {
            bg.style.display = "none";
            registerpopup.style.display = "none";
            sBox.style.display = "none"
        })

        cancelBtnforE.addEventListener("click", function () {
            bg.style.display = "none";
            registerpopup.style.display = "none";
            goEventBox.style.display = "none"
        })

        attendBtn.addEventListener("click", function () {
            if (document.getElementById("signinIcon").style.display == "block") {
                bg.style.display = "block"
                registerpopup.style.display = "block"
                registerpopup.style.backgroundColor = "#D3D3D3"
                sBox.style.display = "block"
                reBox.style.display = "none"
                goEventBox.style.display = "none"

            } else {
                registered()
            }
        })

        function goSignin() {
            window.location.replace("/accounts")
        }

        function goMycollection() {
            window.location.replace("/myevent")
        }


        // bgBtn.addEventListener("click", function () {
        //     bg.style.display = "none";
        //     registerpopup.style.display = "none"
        //     reBox.style.display = "none"
        //     return false;
        // })


        async function theEvent(eId) {
            await fetch(`/api/theevent?e=${eId}`, { method: "GET" })
                .then(response => {
                    return response.json()
                }).then(re => {
                    let wrap = document.getElementById("wrap")
                    let pageCover = document.getElementById("pageCover")
                    let attendEvents = document.getElementById("attendEvents")
                    let eventBody = document.getElementById("eventBody")
                    let eventDes = document.getElementById("eventDes")
                    let eventTime = document.getElementById("eventTime")
                    let downTime = document.getElementById("downTime")
                    let loca = document.getElementById("loca")

                    let img_tag = document.createElement("div")
                    let title_tag = document.createElement("div")
                    let organiser_tag = document.createElement("div")
                    let eventDes_tag = document.createElement("div")
                    let date_tag = document.createElement("div")
                    let upDate_tag = document.createElement("div")
                    let uDate = document.createElement("div")
                    let uMonth = document.createElement("div")
                    let time_tag = document.createElement("div")
                    let loca_tag = document.createElement("div")

                    img_tag.setAttribute("id", "theEventCover")
                    upDate_tag.setAttribute("id", "upperDate")
                    title_tag.setAttribute("id", "theEventTitle")
                    organiser_tag.setAttribute("id", "organiser")
                    eventDes_tag.setAttribute("id", "bodyDes")

                    img_tag.style.backgroundImage = `url(${re.theCover})`
                    uDate.innerHTML = re.thesDate
                    uMonth.innerHTML = re.thesMonth
                    title_tag.innerHTML = re.theTitle
                    organiser_tag.innerHTML = "by " + re.theUser

                    eventDes_tag.innerHTML = re.theDes
                    date_tag.innerHTML = re.thesDay + ", " + re.thesDate + " " + re.thesMonth + " " + re.thesYear
                    time_tag.innerHTML = re.thesTime
                    loca_tag.innerHTML = "Online event"

                    upDate_tag.appendChild(uDate)
                    upDate_tag.appendChild(uMonth)
                    attendEvents.appendChild(upDate_tag)
                    attendEvents.appendChild(title_tag)
                    attendEvents.appendChild(organiser_tag)
                    pageCover.appendChild(img_tag)
                    pageCover.appendChild(attendEvents)

                    eventDes.appendChild(eventDes_tag)
                    downTime.appendChild(date_tag)
                    downTime.appendChild(time_tag)
                    eventLoca.appendChild(loca_tag)

                    if (re.thePeople != null) {
                        document.getElementById("manageAtt").style.display = "block"
                        let list = re.thePeople
                        for (let i = 0; i < list.length; i++) {
                            let attendee = document.getElementById("attendee")
                            let peopleN_tag = document.createElement("div")
                            peopleN_tag.classList.add("peopleN")
                            peopleN_tag.innerHTML = list[i]
                            attendee.appendChild(peopleN_tag)
                        }
                    }else{
                        return
                    }
                })
        }

        async function registered() {

            registerpopup.style.display = "block"
            registerpopup.style.backgroundColor = "white"
            reBox.style.display = "block"
            bg.style.display = "block"

            await fetch("/api/theevent", {
                method: "POST",
                headers: {
                    "content-type": "application/json"
                },
                body: JSON.stringify({
                    reEventId: eventId,
                })
            })
                .then(response => {
                    return response.json()
                }).then(data => {
                    console.log(data)
                    if (data.ok == true) {
                        registerpopup.style.display = "none"
                        reBox.style.display = "none"
                        bg.style.display = "none"
                        alert("Successfully registered! Please go check your email for event link.")
                    } else {
                        registerpopup.style.display = "block"
                        registerpopup.style.backgroundColor = "white"
                        reBox.style.display = "none"
                        sBox.style.display = "none"
                        goEventBox.style.display = "block"
                        bg.style.display = "block"
                    }

                })
        }

    </script>

    <script>
        //MEMBER SYSTEM

        checkProcess()

        let memIcon = document.getElementById("memIcon")
        let memToggle = document.getElementById("memToggle")

        async function checkProcess() {
            await fetch("/api/user", { method: "GET" })
                .then(response => {
                    return response.json()
                }).then(res => {
                    if (res.data == true) {
                        signinIcon.style.display = "none"
                        memIcon.style.display = "block"
                    } else {
                        signinIcon.style.display = "block"
                        memIcon.style.display = "none"
                    }
                })
        }

        memIcon.addEventListener("mousemove", () => {
            memToggle.style.display = "block"
        })

        // memIcon.addEventListener("mouseout", () => {
        //     memToggle.style.display = "none"
        // })

        memToggle.addEventListener("mouseout", () => {
            memToggle.style.display = "none"
        })

        memToggle.addEventListener("mouseover", () => {
            memToggle.style.display = "block"
        })


        document.getElementById("signoutProcess").addEventListener("click", function () {
            logoutProcess()
            signOut()
        })


        function onLoad() {
            gapi.load('auth2', function () {
                gapi.auth2.init();
            });
        }

        async function logoutProcess() {
            var auth2 = gapi.auth2.getAuthInstance();
            auth2.signOut().then(function () {
                console.log('User signed out.');
            });
            await fetch("/api/user", {
                method: "DELETE",
                headers: {
                    "content-type": "application/json"
                },
            }).then(response => {
                return response.json()
            }).then(result => {
                if (result.ok == true) {
                    document.getElementById("manageAtt").style.display = "none"
                    location.reload()
                }
            })
        }
    </script>
</body>

</html>