<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://apis.google.com/js/platform.js?onload=onLoad" async defer></script>
    <meta name="google-signin-client_id"
        content="807588094774-v7tcl63kqsj96r64gaqhtu8gsn81ffnt.apps.googleusercontent.com">
    <title>BookTitle</title>
    <link rel="stylesheet" href="{{url_for('static',filename='css/base.css')}}">
</head>

<body>
    <style>
        .theBook {
            display: flex;
            width: 1200px;
            flex-direction: row;
            margin: 10px auto;
            padding: 10px;
        }

        #theBookCover {
            width: 180px;
            height: 250px;
            box-shadow: 10px 10px 20px;
        }

        #imgSec {
            margin: 20px;
        }

        #infoSec {
            margin: 20px;
            position: relative;

        }

        #theBookTitle {
            font-size: 35px;
            margin: 10px 0;
            font-weight: bold;
            color: black
        }

        #theBookDes {
            white-space: pre-wrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            margin: 10px 0;
            line-height: 30px;
        }

        #rateSec {
            display: flex;
            flex-direction: row;
            align-items: center;
        }

        .ratings {
            margin: 10px 20px 10px 0px;
        }

        #googleRatesNum {
            font-size: 28px;
        }

        .subRates {
            color: gray;
            font-style: italic
        }

        .extraLink a {
            color: #a6a6a8
        }

        .extraLink a:hover {
            color: #8696a7
        }

        #more {
            position: absolute;
            right: 0px;
        }

        #more a {
            color: gray;
            font-size: 40px;
        }

        #bookSpec,
        #authorSec {
            margin: 20px;
            line-height: 30px;
        }

        #authorSec p {
            font-size: 28px;
            margin-top: -18px;
        }

        #reviewBox {
            position: fixed;
            width: 800px;
            height: 600px;
            left: 50%;
            top: 80px;
            transform: translateX(-50%);
            box-shadow: 0px 4px 60px #AAAAAA;
            z-index: 999;
            background-color: white;
            border-radius: 20px;
        }

        #rBox {
            position: absolute;
            display: flex;
            flex-direction: column;
            top: 30px;
            width: 750px;
            height: 550px;
            overflow: auto;
            padding-left: 50px;
        }

        #infoStar {
            display: flex;
            flex-direction: column;
        }

        #reviewTitle {
            font-weight: bold;
            font-size: 35px;
            color: #656565;
            text-align: center;
            margin-left: -30px;
        }

        #memberTitle {
            font-size: 28px;
            color: black;
            font-weight: 600;
            margin: 10px;
        }

        #stars {
            display: flex;
            flex-direction: row;
            width: 150px;
            justify-content: space-around;
            color: gainsboro;
            margin: 10px;
            font-size: 22px;
            cursor: pointer;
        }

        i.fas.fa-star span {
            font-size: 0px;
        }

        #reviews {
            display: flex;
            flex-direction: column;
        }

        #commentBox {
            margin: 10px;
            width: 650px;
            border-bottom: 1px solid gray;
            background-color: #f8f8f8;
            min-height: 150px;
            color: #161B22;
            outline: none;
            font-size: 20px
        }

        #commentBox:empty:before {
            content: attr(data-placeholder);
            color: gray;
        }

        #photoTogether {
            display: flex;
            flex-direction: row;
        }

        #showimg {
            width: 200px;
        }

        input[type="file"] {
            display: none;
        }

        #commentBtn {
            position: absolute;
            width: 100px;
            height: 50px;
            right: 85px;
            margin-top: 10px;
            color: white;
            background-color: #c5b8a5;
            border: 1px solid #c5b8a5;
            border-radius: 8px;
            font-family: Helvetica;
            font-size: 20px;
            cursor: pointer;
        }

        #commentBtn:hover {
            background-color: white;
            color: black;
        }

        #writeSec {
            display: flex;
            flex-direction: column;
            padding: 0px 10px;
        }

        #relatedSec {
            display: flex;
            flex-direction: column;
            padding: 0px 10px;
        }

        #thumbW {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-around;
            background-color: #f0ebe5;
            height: 150px;
            margin-bottom: 10px;
            padding: 0px 50px
        }

        .fa-thumbs-up,
        .fa-google {
            font-size: 50px;
            color: white;
            margin-bottom: 10px;
            color: #6b5152;
        }

        #write {
            border: 1px solid white;
            color: #656565;
            font-size: 30px;
            background-color: white;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            padding: 0px 5px;
            box-shadow: 10px 10px 10px;
        }

        #write:hover {
            color: black
        }

        .secBar {
            display: flex;
            flex-direction: row;
            align-items: center;
            margin: 40px 0px 35px 0px;
        }

        .secBarS {
            background-color: #c5b8a5;
            height: 20px;
            width: 20px;
        }

        .secBarL {
            background-color: #c5b8a5;
            height: 10px;
            flex-grow: 2;
        }

        .secBarTitle {
            font-size: 28px;
            font-weight: bold;
            margin: 0px 10px;
            color: black;
        }

        #reviewSec {
            margin: 20px;
            line-height: 30px;
        }

        .indiReview {
            display: flex;
            flex-direction: column;
            border: 1px solid gray;
            border-radius: 8px;
            padding: 20px;
            background: #f0ebe5;
        }

        .together {
            display: flex;
            flex-direction: row;
        }

        .reviewer {
            flex-grow: 1;
            font-size: 24px;
        }

        .reviewImage {
            width: 360px;
        }

        #recommendBox {
            overflow: hidden;
            position: relative
        }

        #recBox {
            position: relative;
            width: 2500px;
            height: 220px;
        }


        .arrowL {
            width: 40px;
            height: 200px;
            position: absolute;
            cursor: pointer;
        }


        .fa-arrow-alt-circle-left {
            font-size: 30px;
            position: absolute;
            top: 50%;
            transform: translateY(50%);
            left: 5px;
            z-index: 5;
            opacity: 0.7;
            cursor: pointer;
        }

        .arrowR {
            width: 40px;
            height: 200px;
            position: absolute;
            right: 0px;
            cursor: pointer;
        }


        .fa-arrow-alt-circle-right {
            font-size: 30px;
            position: absolute;
            top: 50%;
            transform: translateY(50%);
            right: 5px;
            z-index: 5;
            opacity: 0.7;
            cursor: pointer;
        }

        .recUrl {
            margin: 0px 5px;
            box-shadow: 0px 4px 10px black;
        }

        .recUrl img {
            height: 190px;
        }

        #events {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        #event3 {
            display: flex;
            flex-direction: row;
        }

        .eventSB {
            border: 1px solid gray;
            border-radius: 8px;
            height: 100px;
            width: 400px;
            background-color: white;
            margin-right: 30px;
        }

        .coverS {
            background-size: cover;
            width: 150px;
            height: 100px;
            border-top-left-radius: 8px;
            border-bottom-left-radius: 8px;
        }

        .linkS {
            display: flex;
            flex-direction: row;
            color: #656565;
        }

        .linkS:hover {
            box-shadow: 0px 1px 6px;
        }

        .infoS {
            padding: 10px;
        }

        .titleS {
            line-height: 3;
        }

        #allEventsPage {
            position: absolute;
            bottom: -30px;
            right: 0px;
        }

        #allEventsPage a{
            color: #656565;
        }

        #allEventsPage a:hover{
            color: black;
        }
    </style>


    <div class="searchEngine">
        <div class="Header">
            <a href="/">BooKÏ</a>
        </div>

        <form class="searchSection">

            <div id="bundle" class="bundle">
                <input type="text" id="searchBar" class="searchBar" placeholder="Title or Author">
                <button class="searchBtn" onclick="searchGo(event)"><i class="fas fa-search"></i></button>
            </div>
            <div id="toggle" class="toggle" style="display: none"></div>
        </form>

        <div class="nav">
            <div class="menu"><a id="eventPage" href="/events">Events</a></div>
            <!-- <div class="menu mybookIcon" id="mybookIcon"><a id="mybookProcess" class="mybookProcess" href="#"><i
                        class="fas fa-book"></i></a></div> -->
            <div class="menu signinIcon" id="signinIcon" style="display: none"><a id="signinProcess"
                    class="signinProcess" href="/accounts">Sign in</a></div>
            <div class="menu signoutIcon" id="signoutIcon" style="display: none"><a id="signoutProcess"
                    class="signoutProcess" href="#"><i class="fas fa-user-astronaut"></i></a></div>
        </div>
    </div>

    <div class="theBook" style="margin-top: 150px">
        <div id="imgSec"></div>
        <div id="infoSec"></div>
    </div>

    <div class="theBook">
        <div id="bookSpec">
            <div class="secBar">
                <div class="secBarS"></div>
                <div class="secBarTitle">Book Details</div>
                <div class="secBarL"></div>
            </div>
        </div>


        <div id="authorSec">
            <div class="secBar">
                <div class="secBarS"></div>
                <div class="secBarTitle">About Author</div>
                <div class="secBarL"></div>
            </div>
        </div>
    </div>

    <div class="theBook" style="flex-direction: column">
        <div id="relatedSec">
            <div id="thumbW">
                <div>
                    <i id="googleRate" class="fab fa-google"></i>
                    <div class="subRates">Average Googler Score</div>
                </div>
                <div>
                    <i id="thumbRate" class="far fa-thumbs-up"></i>
                    <div class="subRates">Average BooKÏer Score</div>
                </div>
                <div id="write">write a review</div>
            </div>

            <div id="recommendBox">
                <div class="secBar">
                    <div class="secBarS"></div>
                    <div class="secBarTitle">Popular search in BooKÏ</div>
                    <div class="secBarL"></div>
                </div>
                <div class="arrowL"></div>
                <i id="arrowLicon" class="fas fa-arrow-alt-circle-left"></i>
                <div class="arrowR"></div>
                <i id="arrowRicon" class="fas fa-arrow-alt-circle-right"></i>
                <div id="recBox"></div>
            </div>

            <div id="events">
                <div class="secBar">
                    <div class="secBarS"></div>
                    <div class="secBarTitle">Events you might like...</div>
                    <div class="secBarL"></div>
                </div>

                <div id="allEventsPage"><a href="/events">See All Events</a></div>

                <div id="event3"></div>
            </div>

        </div>
        <div id="writeSec">
            <div class="secBar">
                <div class="secBarS"></div>
                <div class="secBarTitle">Rate and Review</div>
                <div class="secBarL"></div>
            </div>
            <div id="reviews">
                <div id="reviewSec"></div>
            </div>
        </div>

    </div>

    <!-- <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-show-count="false">Tweet</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script> -->

    <label><a id="bgBtn" href="javascript:void(0)">
            <div id="bg" class="bg"></div>
        </a></label>

    <div id="reviewBox" style="display: none">
        <div id="rBox" style="display: none">
            <div id="reviewTitle">Write down your review</div>
            <div id="infoStar">
                <div id="memberTitle">{{session.memberName}}</div>
                <div id="stars">
                    <i class="fas fa-star"><span>1</span></i>
                    <i class="fas fa-star"><span>2</span></i>
                    <i class="fas fa-star"><span>3</span></i>
                    <i class="fas fa-star"><span>4</span></i>
                    <i class="fas fa-star"><span>5</span></i>
                </div>
            </div>
            <div id="photoTogether">
                <label for="uploadFile" class="custom-file-upload">
                    <i class="fa fa-cloud-upload"></i> Upload
                </label>
                <input type="file" name="photo" id="uploadFile" onchange="showImg(this)">
                <img id="showimg" src="" style="display:none;" />
            </div>
            <div contenteditable="true" id="commentBox" data-placeholder="Edit me"></div>
            <button id="commentBtn" onclick="uploadComment(event)">Send</button>
        </div>


        <div id="sBox" class="sBox" style="display: none">
            <i class="fas fa-user-cog"></i><br>
            <div style=>Sign in with your BooKÏ Account to write a review</div>
            <button id="cancelBtn" class="cancelBtn">cancel</button><button id="gosigninBtn" class="gosigninBtn"
                onclick="goSignin()">Sign in</button>
        </div>
    </div>



    <script src="https://kit.fontawesome.com/cbebce4b6d.js" crossorigin="anonymous"></script>
    <script src="{{url_for('static',filename='js/base.js')}}"></script>

    <script>
        // MAIN SCRIPT
        let src = window.location.href;
        let srcId = src.split("/")[4];
        let bookId;
        let moreIcon = false

        getTheBook(srcId)

        async function getTheBook(bookId) {
            await fetch("https://www.googleapis.com/books/v1/volumes/" + `${bookId}`)
                .then(response => {
                    return response.json();
                }).then(result => {
                    theBookInfo(result)
                    theBookSpec(result)
                })
        };

        function theBookInfo(data) {
            let theBook = document.getElementsByClassName("theBook")[0]
            let imgSec = document.getElementById("imgSec")
            let infoSec = document.getElementById("infoSec")
            let theBookCover_img = document.createElement("img")
            let theBookTitle_tag = document.createElement("div")
            let authors_tag = document.createElement("div")
            let aForauthors_tag = document.createElement("a")
            let ratings_tag = document.createElement("div")
            let emptyStar_tag = document.createElement("div")
            let fullStar_tag = document.createElement("div")
            let rateSec_tag = document.createElement("div")
            let ratesNum_tag = document.createElement("div")
            let googleRates_tag = document.createElement("div")
            let theBookDes_tag = document.createElement("div")
            let more_tag = document.createElement("div")
            let a_tag = document.createElement("a")
            let i_tag = document.createElement("i")

            aForauthors_tag.href = `/search?q=inauthor:${data.volumeInfo.authors}`
            a_tag.href = "javascript:;"

            let theBookTitle = document.createTextNode(data.volumeInfo.title)
            let emptyS = document.createTextNode("★★★★★")
            let fullS = document.createTextNode("★★★★★")


            theBookCover_img.setAttribute("id", "theBookCover")
            theBookTitle_tag.setAttribute("id", "theBookTitle")
            authors_tag.classList.add("extraLink")
            authors_tag.setAttribute("style", "font-size: 28px")
            rateSec_tag.setAttribute("id", "rateSec")
            ratings_tag.classList.add("ratings")
            ratesNum_tag.setAttribute("id", "googleRatesNum")
            googleRates_tag.classList.add("subRates")
            emptyStar_tag.classList.add("empty_star")
            fullStar_tag.classList.add("full_star")
            theBookDes_tag.setAttribute("id", "theBookDes")
            more_tag.setAttribute("id", "more")
            i_tag.classList.add("fas")
            i_tag.classList.add("fa-caret-down")

            theBookCover_img.src = data.volumeInfo.imageLinks.thumbnail

            // whether rating exits or not
            let ratingData = data.volumeInfo.averageRating
            let googleRate = document.getElementById("googleRate")
            if (ratingData != null) {
                let filterStar = rateArr.filter(function (element, index, array) {
                    return element.ratingNum == ratingData
                })
                fullStar_tag.style.width = filterStar[0].ratingLen
                ratesNum_tag.innerHTML = ratingData
                googleRates_tag.innerHTML = "(from Google rating)"
                googleRate.innerHTML = ratingData * 20 + "%"

            } else {
                fullStar_tag.setAttribute("style", "width: 0%");
                googleRates_tag.innerHTML = "0 Reviews"
                googleRate.style.color = "gray"
                googleRate.innerHTML = " --"
            }


            // whether book description exits or not
            let theBookDes = data.volumeInfo.description
            !theBookDes ? theBookDes_tag.innerHTML = "no description" : theBookDes_tag.innerHTML = theBookDes

            theBookTitle_tag.appendChild(theBookTitle)
            aForauthors_tag.innerHTML = "by" + " " + data.volumeInfo.authors
            authors_tag.appendChild(aForauthors_tag)
            emptyStar_tag.appendChild(emptyS)
            fullStar_tag.appendChild(fullS)
            ratings_tag.appendChild(emptyStar_tag)
            ratings_tag.appendChild(fullStar_tag)
            rateSec_tag.appendChild(ratings_tag)
            rateSec_tag.appendChild(ratesNum_tag)
            rateSec_tag.appendChild(googleRates_tag)

            a_tag.appendChild(i_tag)
            more_tag.appendChild(a_tag)
            imgSec.appendChild(theBookCover_img)
            infoSec.appendChild(theBookTitle_tag)
            infoSec.appendChild(authors_tag)
            infoSec.appendChild(rateSec_tag)
            infoSec.appendChild(theBookDes_tag)
            infoSec.appendChild(more_tag)
            theBook.appendChild(imgSec)
            theBook.appendChild(infoSec)

            document.getElementById("more").addEventListener("click", function () {
                if (moreIcon == false) {
                    console.log("open")
                    document.getElementById("theBookDes").style.display = "block"
                } else {
                    console.log("close")
                    document.getElementById("theBookDes").style.display = "-webkit-box"
                }
                moreIcon = !moreIcon
            })
        }

        function theBookSpec(res) {
            let bookSpec = document.getElementById("bookSpec")
            let publisher = document.createElement("div")
            let ISBN = document.createElement("div")
            let pageCount = document.createElement("div")
            let dimensions = document.createElement("div")
            let categories = document.createElement("div")

            categories.classList.add("extraLink")

            publisher.innerHTML = "出版商:" + "&nbsp" + res.volumeInfo.publisher + "&nbsp" + "," + "&nbsp" + res.volumeInfo.publishedDate

            !res.volumeInfo.industryIdentifiers ? console.log("no ISBN") : ISBN.innerHTML = "ISBN:" + "&nbsp" + res.volumeInfo.industryIdentifiers[0].identifier + "&nbsp" + "(ISBN10)," + "&nbsp" + res.volumeInfo.industryIdentifiers[1].identifier + "&nbsp" + "(ISBN13)"

            pageCount.innerHTML = "頁數:" + "&nbsp" + res.volumeInfo.pageCount + "&nbsp" + "頁"

            if (res.volumeInfo.dimensions != null) {
                dimensions.innerHTML = "規格:" + "&nbsp" + res.volumeInfo.dimensions.height + "&nbsp" + "x" + "&nbsp" + res.volumeInfo.dimensions.width + "&nbsp" + "x" + "&nbsp" + res.volumeInfo.dimensions.thickness
            } else {
                console.log("No dimensions")
            }

            categories.innerHTML = "本書分類:<br>"
            for (let i = 0; i < res.volumeInfo.categories.length; i++) {
                let url_tag = document.createElement("a")
                let br_tag = document.createElement("br")
                url_tag.href = `/search?q=subject:${res.volumeInfo.categories[i]}`
                url_tag.innerHTML = res.volumeInfo.categories[i]
                url_tag.appendChild(br_tag)
                categories.appendChild(url_tag)
            }

            bookSpec.appendChild(publisher)
            bookSpec.appendChild(ISBN)
            bookSpec.appendChild(pageCount)
            bookSpec.appendChild(dimensions)
            bookSpec.appendChild(categories)

        }

    </script>

    <script>
        //GET AUTHOR
        //RECOMMEND BOOKS
        //GET EVENTS

        getAuthor(srcId)
        recCounts(srcId)
        getEvents()

        let recBox = document.getElementById("recBox")
        let arrowL = document.getElementsByClassName("arrowL")[0]
        let arrowR = document.getElementsByClassName("arrowR")[0]
        let arrowLicon = document.getElementById("arrowLicon")
        let arrowRicon = document.getElementById("arrowRicon")

        recBox.addEventListener("mouseover", function () {
            arrowL.style.opacity = "0.2"
            arrowL.style.backgroundColor = "white"
            arrowL.style.zIndex = "2"
            arrowR.style.opacity = "0.2"
            arrowR.style.backgroundColor = "white"
            arrowR.style.zIndex = "2"
        })

        recBox.addEventListener("mouseout", function () {
            arrowL.style.opacity = "0"
            arrowR.style.opacity = "0"
        })

        arrowL.addEventListener("mouseover", function () {
            arrowL.style.opacity = "0.5"
            arrowL.style.backgroundColor = "white"
            arrowL.style.zIndex = "2"
            arrowR.style.opacity = "0.2"
            arrowR.style.backgroundColor = "white"
            arrowR.style.zIndex = "2"
        })

        arrowR.addEventListener("mouseover", function () {
            arrowL.style.opacity = "0.2"
            arrowL.style.backgroundColor = "white"
            arrowL.style.zIndex = "2"
            arrowR.style.opacity = "0.5"
            arrowR.style.backgroundColor = "white"
            arrowR.style.zIndex = "2"
        })

        let LR = 0
        let arrL = false
        let arrR = true

        arrowR.addEventListener("click", function () {
            if (LR > -959 & arrL == false) {
                LR -= 480
                recBox.style.left = LR + "px"
                arrL = false
                arrR = false
            } else {
                LR = -1200
                recBox.style.left = "-1200px"
                arrL = true
                arrR = false
            }
        })

        arrowRicon.addEventListener("click", function () {
            if (LR > -959 & arrL == false) {
                LR -= 480
                recBox.style.left = LR + "px"
                arrL = false
                arrR = false
            } else {
                LR = -1200
                recBox.style.left = "-1200px"
                arrL = true
                arrR = false
            }
        })

        arrowL.addEventListener("click", function () {
            if (LR < -241 & arrR == false) {
                LR += 480
                recBox.style.left = LR + "px"
                arrL = false
                arrR = false
            } else if (LR == -1200) {
                LR += 480
                recBox.style.left = LR + "px"
                arrL = false
                arrR = false
            } else {
                LR = 0
                recBox.style.left = "0px"
                arrL = false
                arrR = true
            }
        })

        arrowLicon.addEventListener("click", function () {
            if (LR < -241 & arrR == false) {
                LR += 480
                recBox.style.left = LR + "px"
                arrL = false
                arrR = false
            } else if (LR == -1200) {
                LR += 480
                recBox.style.left = LR + "px"
                arrL = false
                arrR = false
            } else {
                LR = 0
                recBox.style.left = "0px"
                arrL = false
                arrR = true
            }
        })


        async function getAuthor(bId) {

            await fetch(`/api/authors?a=${bId}`, { method: "GET" })
                .then(response => {
                    return response.json()
                }).then(re => {
                    let author = re.aboutAuthor
                    let authorSec = document.getElementById("authorSec")
                    let aboutAuthor_tag = document.createElement("div")

                    aboutAuthor_tag.setAttribute("id", "aboutAuthor")

                    aboutAuthor_tag.innerHTML = author
                    authorSec.appendChild(aboutAuthor_tag)
                })
        }

        async function recCounts(recId) {
            console.log(recId)

            await fetch(`/api/recommend?rec=${recId}`, { method: "GET" })
                .then(response => {
                    return response.json()
                }).then(data => {
                    let results = data.recBooks
                    for (let i = 0; i < results.length; i++) {
                        let d = results[i].items[0].volumeInfo
                        let a_tag = document.createElement("a")
                        let img_tag = document.createElement("img")

                        a_tag.classList.add("recUrl")
                        img_tag.src = d.imageLinks.thumbnail
                        a_tag.href = `/bookInfo/${results[i].items[0].id}`
                        a_tag.appendChild(img_tag)
                        recBox.appendChild(a_tag)
                    }
                })
        }

        async function getEvents() {
            await fetch("/api/bookievents", { method: "GET" })
                .then(response => {
                    return response.json()
                }).then(data => {
                    eventsAll = data.allEvents
                    for (let i = 0; i < 3; i++) {
                        let event3 = document.getElementById("event3")
                        let eventSB = document.createElement("div")
                        let img_tag = document.createElement("div")
                        let infoS = document.createElement("div")
                        let titleS = document.createElement("div")
                        let timeS = document.createElement("div")
                        let a_tag = document.createElement("a")

                        eventSB.classList.add("eventSB")
                        img_tag.classList.add("coverS")
                        infoS.classList.add("infoS")
                        titleS.classList.add("titleS")
                        timeS.classList.add("timeS")
                        a_tag.classList.add("linkS")

                        titleS.innerHTML = eventsAll[i].aTitle.toUpperCase()
                        img_tag.style.backgroundImage = `url(${eventsAll[i].aCover})`
                        timeS.innerHTML = eventsAll[i].asDay + ", " + eventsAll[i].asDate + ", " + eventsAll[i].asMonth + ", " + eventsAll[i].asYear + ", " + eventsAll[i].asTime
                        a_tag.href = `/e/${eventsAll[i].aTitle}`

                        infoS.appendChild(titleS)
                        infoS.appendChild(timeS)
                        a_tag.appendChild(img_tag)
                        a_tag.appendChild(infoS)
                        eventSB.appendChild(a_tag)
                        event3.appendChild(eventSB)
                    }
                })
        }

    </script>

    <script>
        // SEARCH ENGINE

        let searchBar = document.getElementById("searchBar")
        let toggle = document.getElementById("toggle")
        let bundle = document.getElementById("bundle")

        function searchGo(e) {
            e.preventDefault()
            if (searchBar.value != "") {
                searchPage()
            }
        }

        function searchPage() {
            let query;
            query = searchBar.value
            window.location.replace(`/search?q=${query}`)
        }

        document.addEventListener("click", function (e) {
            if (e.target != document.getElementsByTagName("div")[6]) {
                toggle.style.display = "none"
                bundle.style.borderRadius = "24px"
            }
        })

        toggle.addEventListener("click", function (e) {
            let targetW = e.target.innerHTML
            if ((targetW.indexOf("<") != -1) == false) {
                window.location.replace(`/search?q=${targetW}`)
                toggle.style.display = "none"
                bundle.style.borderRadius = "24px"
            }
        })

        searchBar.oninput = function () {

            if (searchBar.value != "") {
                fetch("/api/searchEngine", {
                    method: "POST",
                    headers: {
                        "content-type": "application/json"
                    },
                    body: JSON.stringify({
                        key: searchBar.value
                    }),
                })
                    .then(reponse => {
                        return reponse.json()
                    }).then(res => {
                        let books = res.ok
                        preview(books)
                    })
            } else {
                searchBar.style.borderRadius = "24px"
            }
        }

        function preview(data) {
            // console.log(data)
            if (data != "") {
                bundle.style.borderRadius = "24px 24px 0px 0px"
                toggle.style.display = "block"
                toggle.innerHTML = ""
                let search_str = ""
                for (let i = 0; i < data.length; i++) {
                    var a = '<a href="javascript:;">' + data[i] + '</a><br>'
                    search_str += a
                    toggle.innerHTML = search_str
                }

            } else {
                toggle.style.display = "none"
                bundle.style.borderRadius = "24px"
            }
        }
    </script>

    <script>
        // REVIEW & STARS BOARD

        loadComment(srcId)

        let commentBox = document.getElementById("commentBox")
        let reviewSec = document.getElementById("reviewSec")
        let bg = document.getElementById("bg");
        let bgBtn = document.getElementById("bgBtn")
        let stars = document.getElementById("stars")
        let oStar = document.getElementsByClassName("fas fa-star")
        let starRates;
        let reviewBox = document.getElementById("reviewBox")
        let rBox = document.getElementById("rBox")
        let sBox = document.getElementById("sBox")

        bgBtn.onclick = function () {
            bg.style.display = "none";
            reviewBox.style.display = "none"
            rBox.style.display = "none"
            return false;
        }

        document.getElementById("cancelBtn").addEventListener("click", function () {
            bg.style.display = "none"
            reviewBox.style.display = "none"
            sBox.style.display = "none"
            rBox.style.display = "none"
        })


        stars.addEventListener("click", function (e) {
            let targetS = e.target.innerHTML
            if (targetS.indexOf("class") == -1) {
                if ((targetS.indexOf(1) != -1) == true) {
                    oStar[0].style.color = "orange"
                    oStar[1].style.color = "gainsboro"
                    oStar[2].style.color = "gainsboro"
                    oStar[3].style.color = "gainsboro"
                    oStar[4].style.color = "gainsboro"
                    starRates = 1
                } else if ((targetS.indexOf(2) != -1) == true) {
                    oStar[0].style.color = "orange"
                    oStar[1].style.color = "orange"
                    oStar[2].style.color = "gainsboro"
                    oStar[3].style.color = "gainsboro"
                    oStar[4].style.color = "gainsboro"
                    starRates = 2
                } else if ((targetS.indexOf(3) != -1) == true) {
                    oStar[0].style.color = "orange"
                    oStar[1].style.color = "orange"
                    oStar[2].style.color = "orange"
                    oStar[3].style.color = "gainsboro"
                    oStar[4].style.color = "gainsboro"
                    starRates = 3
                } else if ((targetS.indexOf(4) != -1) == true) {
                    oStar[0].style.color = "orange"
                    oStar[1].style.color = "orange"
                    oStar[2].style.color = "orange"
                    oStar[3].style.color = "orange"
                    oStar[4].style.color = "gainsboro"
                    starRates = 4
                } else {
                    oStar[0].style.color = "orange"
                    oStar[1].style.color = "orange"
                    oStar[2].style.color = "orange"
                    oStar[3].style.color = "orange"
                    oStar[4].style.color = "orange"
                    starRates = 5
                }
            }

        })

        write.onclick = function () {
            if (document.getElementById("signinIcon").style.display == "block") {
                bg.style.display = "block"
                reviewBox.style.display = "block"
                reviewBox.style.backgroundColor = "#D3D3D3"
                sBox.style.display = "block"
                rBox.style.display = "none"
            } else {
                bg.style.display = "block";
                reviewBox.style.display = "block"
                reviewBox.style.backgroundColor = "white"
                rBox.style.display = "block"
                sBox.style.display = "none"
            }
        }

        function goSignin() {
            window.location.replace("/accounts")
        }

        function showImg(thisimg) {
            var file = thisimg.files[0];
            if (window.FileReader) {
                var fr = new FileReader();

                var showimg = document.getElementById('showimg');
                fr.onloadend = function (e) {
                    showimg.src = e.target.result;
                };
                fr.readAsDataURL(file);
                showimg.style.display = 'block';
            }
        }

        async function uploadComment() {
            let selectedFile = document.getElementById('uploadFile').files[0];
            let x = new Date()
            let ydd = `${x.getFullYear()}-${x.getMonth() + 1 < 10 ? "0" + (x.getMonth() + 1) : x.getMonth()}-${x.getDate() + 1}`

            if (selectedFile == null) {
                let formData = new FormData()
                formData.append('title', srcId)
                formData.append('date', ydd)
                formData.append('stars', starRates)
                formData.append('content', commentBox.innerHTML)

                await fetch("/api/reviews", {
                    method: "POST",
                    body: formData,
                }).then(response => {
                    return response.json()
                }).then(re => {
                    // console.log(re)
                    // let indiReview_tag = document.createElement("div")
                    // let reviewer_tag = document.createElement("div")
                    // let review_tag = document.createElement("div")
                    // let reviewTime_tag = document.createElement("div");
                    // let together_tag = document.createElement("div")
                    // let ratings_tag = document.createElement("div")
                    // let emptyStar_tag = document.createElement("div")
                    // let fullStar_tag = document.createElement("div")

                    // let emptyS = document.createTextNode("★★★★★")
                    // let fullS = document.createTextNode("★★★★★")

                    // indiReview_tag.className = "indiReview"
                    // reviewer_tag.className = "reviewer"
                    // review_tag.className = "review"
                    // reviewTime_tag.className = "reviewtTime";
                    // together_tag.className = "together"
                    // ratings_tag.classList.add("ratings")
                    // emptyStar_tag.classList.add("empty_star")
                    // fullStar_tag.classList.add("full_star")

                    // let mRates = re.rates
                    // if (mRates == 1) {
                    //     fullStar_tag.setAttribute("style", "width: 20%")
                    // } else if (mRates == 2) {
                    //     fullStar_tag.setAttribute("style", "width: 40%")
                    // } else if (mRates == 3) {
                    //     fullStar_tag.setAttribute("style", "width: 60%")
                    // } else if (mRates == 4) {
                    //     fullStar_tag.setAttribute("style", "width: 80%")
                    // } else {
                    //     fullStar_tag.setAttribute("style", "width: 100%")
                    // }

                    // reviewer_tag.innerHTML = re.user
                    // review_tag.innerHTML = re.content
                    // reviewTime_tag.innerHTML = re.date
                    // emptyStar_tag.appendChild(emptyS)
                    // fullStar_tag.appendChild(fullS)
                    // ratings_tag.appendChild(emptyStar_tag)
                    // ratings_tag.appendChild(fullStar_tag)

                    // together_tag.appendChild(reviewer_tag)
                    // together_tag.appendChild(reviewTime_tag)
                    // indiReview_tag.appendChild(together_tag)
                    // indiReview_tag.appendChild(ratings_tag)
                    // indiReview_tag.appendChild(review_tag)
                    // reviewSec.appendChild(indiReview_tag)
                    // commentBox.innerHTML = ""

                    // reviewSec.insertBefore(indiReview_tag, reviewSec.childNodes[0])

                    // bg.style.display = "none";
                    // reviewBox.style.display = "none"
                    // rBox.style.display = "none"
                    // document.getElementById("showimg").style.display = "none"
                    // document.getElementById("commentBox").innerHTML = ""
                    // oStar[0].style.color = "gainsboro"
                    // oStar[1].style.color = "gainsboro"
                    // oStar[2].style.color = "gainsboro"
                    // oStar[3].style.color = "gainsboro"
                    // oStar[4].style.color = "gainsboro"
                    location.reload()
                })
            } else {
                let formData2 = new FormData()
                formData2.append('selectFile', selectedFile); // 設定上傳的檔案
                formData2.append('title', srcId)
                formData2.append('date', ydd)
                formData2.append('stars', starRates)
                formData2.append('content', commentBox.innerHTML)

                await fetch("/api/reviews", {
                    method: "POST",
                    body: formData2,
                }).then(response => {
                    return response.json()
                }).then(re => {
                    console.log(re)
                    let indiReview_tag = document.createElement("div")
                    let reviewer_tag = document.createElement("div")
                    let review_tag = document.createElement("div")
                    let reviewTime_tag = document.createElement("div");
                    let together_tag = document.createElement("div")
                    let ratings_tag = document.createElement("div")
                    let emptyStar_tag = document.createElement("div")
                    let fullStar_tag = document.createElement("div")
                    let img = document.createElement("img")

                    img.src = "/img/" + re.imageName

                    let emptyS = document.createTextNode("★★★★★")
                    let fullS = document.createTextNode("★★★★★")

                    indiReview_tag.className = "indiReview"
                    reviewer_tag.className = "reviewer"
                    review_tag.className = "review"
                    reviewTime_tag.className = "reviewtTime";
                    together_tag.className = "together"
                    ratings_tag.classList.add("ratings")
                    emptyStar_tag.classList.add("empty_star")
                    fullStar_tag.classList.add("full_star")
                    img.classList.add("reviewImage")

                    let mRates = re.rates
                    if (mRates == 1) {
                        fullStar_tag.setAttribute("style", "width: 20%")
                    } else if (mRates == 2) {
                        fullStar_tag.setAttribute("style", "width: 40%")
                    } else if (mRates == 3) {
                        fullStar_tag.setAttribute("style", "width: 60%")
                    } else if (mRates == 4) {
                        fullStar_tag.setAttribute("style", "width: 80%")
                    } else {
                        fullStar_tag.setAttribute("style", "width: 100%")
                    }

                    reviewer_tag.innerHTML = re.user
                    review_tag.innerHTML = re.content
                    reviewTime_tag.innerHTML = re.date
                    emptyStar_tag.appendChild(emptyS)
                    fullStar_tag.appendChild(fullS)
                    ratings_tag.appendChild(emptyStar_tag)
                    ratings_tag.appendChild(fullStar_tag)

                    together_tag.appendChild(reviewer_tag)
                    together_tag.appendChild(reviewTime_tag)
                    indiReview_tag.appendChild(together_tag)
                    indiReview_tag.appendChild(ratings_tag)
                    indiReview_tag.appendChild(review_tag)
                    indiReview_tag.appendChild(img)
                    reviewSec.appendChild(indiReview_tag)
                    commentBox.innerHTML = ""

                    reviewSec.insertBefore(indiReview_tag, reviewSec.childNodes[0])

                    bg.style.display = "none";
                    reviewBox.style.display = "none"
                    rBox.style.display = "none"
                    document.getElementById("showimg").style.display = "none"
                    document.getElementById("commentBox").innerHTML = ""
                    oStar[0].style.color = "gainsboro"
                    oStar[1].style.color = "gainsboro"
                    oStar[2].style.color = "gainsboro"
                    oStar[3].style.color = "gainsboro"
                    oStar[4].style.color = "gainsboro"
                    location.reload()
                })
            }
        }

        async function loadComment(url) {
            await fetch(`/api/reviews?r=${url}`, { method: "GET" })
                .then(response => {
                    return response.json()
                }).then(data => {
                    let oldReviews = data.allReviews
                    let thumbRate = document.getElementById("thumbRate")

                    if (data.avgStar != null) {
                        let avgStar = data.avgStar * 20 + "%"
                        thumbRate.innerHTML = avgStar
                    } else {
                        thumbRate.style.color = "gray"
                        thumbRate.innerHTML = " --"
                    }


                    // console.log(oldReviews)
                    for (let n = 0; n < oldReviews.length; n++) {

                        let indiReview_tag = document.createElement("div")
                        let reviewer_tag = document.createElement("div")
                        let review_tag = document.createElement("div")
                        let reviewTime_tag = document.createElement("div");
                        let together_tag = document.createElement("div")
                        let ratings_tag = document.createElement("div")
                        let emptyStar_tag = document.createElement("div")
                        let fullStar_tag = document.createElement("div")
                        let img = document.createElement("img")

                        let emptyS = document.createTextNode("★★★★★")
                        let fullS = document.createTextNode("★★★★★")

                        indiReview_tag.className = "indiReview"
                        reviewer_tag.className = "reviewer"
                        review_tag.className = "review"
                        reviewTime_tag.className = "reviewtTme";
                        together_tag.className = "together"
                        ratings_tag.classList.add("ratings")
                        emptyStar_tag.classList.add("empty_star")
                        fullStar_tag.classList.add("full_star")
                        img.classList.add("reviewImage")

                        let mRates = oldReviews[n].rates
                        if (mRates == 1) {
                            fullStar_tag.setAttribute("style", "width: 20px")
                        } else if (mRates == 2) {
                            fullStar_tag.setAttribute("style", "width: 40px")
                        } else if (mRates == 3) {
                            fullStar_tag.setAttribute("style", "width: 60px")
                        } else if (mRates == 4) {
                            fullStar_tag.setAttribute("style", "width: 80px")
                        } else {
                            fullStar_tag.setAttribute("style", "width: 100px")
                        }

                        reviewer_tag.innerHTML = oldReviews[n].name
                        review_tag.innerHTML = oldReviews[n].content
                        reviewTime_tag.innerHTML = oldReviews[n].time
                        emptyStar_tag.appendChild(emptyS)
                        fullStar_tag.appendChild(fullS)
                        ratings_tag.appendChild(emptyStar_tag)
                        ratings_tag.appendChild(fullStar_tag)

                        together_tag.appendChild(reviewer_tag)
                        together_tag.appendChild(reviewTime_tag)
                        indiReview_tag.appendChild(together_tag)
                        indiReview_tag.appendChild(ratings_tag)
                        indiReview_tag.appendChild(review_tag)

                        if (oldReviews[n].image != null) {
                            img.src = oldReviews[n].image
                            indiReview_tag.appendChild(img)
                        }
                        reviewSec.appendChild(indiReview_tag)

                        reviewSec.insertBefore(indiReview_tag, reviewSec.childNodes[0])
                    }
                })
        }

    </script>

    <script>
        //MEMBER SYSTEM

        checkProcess()

        async function checkProcess() {
            await fetch("/api/user", { method: "GET" })
                .then(response => {
                    return response.json()
                }).then(res => {
                    if (res.data == true) {
                        signinIcon.style.display = "none"
                        signoutIcon.style.display = "block"
                    } else {
                        signinIcon.style.display = "block"
                        signoutIcon.style.display = "none"
                    }
                })
        }

        document.getElementById("signoutProcess").addEventListener("click", function () {
            logoutProcess()
            signOut()
        })


        function onLoad() {
            gapi.load('auth2', function () {
                gapi.auth2.init();
            });
        }

        async function logoutProcess() {
            var auth2 = gapi.auth2.getAuthInstance();
            auth2.signOut().then(function () {
                console.log('User signed out.');
            });
            await fetch("/api/user", {
                method: "DELETE",
                headers: {
                    "content-type": "application/json"
                },
            }).then(response => {
                return response.json()
            }).then(result => {
                if (result.ok == true) {
                    location.reload()
                }
            })
        }
    </script>

</body>

</html>